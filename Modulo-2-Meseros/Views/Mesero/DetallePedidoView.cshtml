@model List<Modulo_2_Meseros.Models.DetallePedido>

@{
    ViewData["Title"] = "Detalle del Pedido";

    // Inicializar variables con valores por defecto
    var mesa = 0;
    var pedido = 0;
    var mesero = "Mesero";
    var total = 0m;

    // Solo procesar si el modelo no es nulo
    if (Model != null)
    {
        mesa = Model.FirstOrDefault()?.IdPedidoNavigation?.IdMesa ?? 0;
        pedido = Model.FirstOrDefault()?.IdPedido ?? 0;
        mesero = Model.FirstOrDefault()?.IdPedidoNavigation?.IdMeseroNavigation?.Nombre ?? "Mesero";
        total = Model.Sum(d => d.DetSubtotal ?? 0);
    }
}

<link rel="stylesheet" href="~/css/detalle-pedido.css"/>

<div class="container mt-4">
    <h2 class="mb-2">Pedido#@pedido - Mesa #@mesa</h2>
    <h5 class="text-muted mb-4">Atendido por: @mesero</h5>

    <div class="row">
        <!-- Lista de platos -->
        <div class="col-lg-8">
            <div class="mb-3">
                <h4 class="text-secondary">🍽️ Platos del Pedido</h4>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> No hay platos añadidos al pedido.
                    Por favor, agregue platos usando los botones siguientes.
                </div>
            }
            else
            {
                @foreach (var plato in Model)
                {
                    var nombreItem = plato.IdMenuNavigation?.Platos?.Nombre
                    ?? plato.IdMenuNavigation?.Combo?.Nombre
                    ?? plato.IdMenuNavigation?.Promocion?.Descripcion
                    ?? "[Sin nombre]";

                    <div class="card shadow-sm mb-3">
                        <div class="card-body">
                            <div class="row align-items-center text-center">
                                <div class="col-md-3 text-start">
                                    <strong class="fs-6">@nombreItem</strong>
                                    <div class="small text-muted">Comentarios: @(plato.DetComentarios ?? "Sin comentarios")</div>
                                </div>

                                <div class="col-md-2">
                                    <span class="badge
                        @(plato.IdEstadopedidoNavigation?.EstadoNombre == "Solicitado" ? "bg-warning" :
                          plato.IdEstadopedidoNavigation?.EstadoNombre == "En Proceso" ? "bg-info" :
                          plato.IdEstadopedidoNavigation?.EstadoNombre == "Entregado" ? "bg-success" :
                          plato.IdEstadopedidoNavigation?.EstadoNombre == "Finalizado" ? "bg-secondary" :
                          "bg-dark")">
                                        @plato.IdEstadopedidoNavigation?.EstadoNombre
                                    </span>
                                </div>

                                <div class="col-md-1">
                                    <span class="badge bg-dark">@plato.DetCantidad</span>
                                </div>

                                <div class="col-md-2">
                                    $@plato.DetSubtotal?.ToString("0.00")
                                </div>

                                <div class="col-md-4 text-end">
                                    <!-- ✔️ Cambiar a Entregado (estado 4) -->
                                    @if (plato.IdEstadopedido == 3 )
                                    {
                                        <form asp-action="CambiarEstadoDetallePedido" method="post" class="d-inline">
                                            <input type="hidden" name="idDetallePedido" value="@plato.IdPedido" />
                                            <input type="hidden" name="idMenu" value="@plato.IdMenu" />
                                            <input type="hidden" name="IdEstadoDetallePedido" value="4" />
                                            <button type="submit" class="btn btn-outline-success btn-sm me-1" title="Marcar como Entregado">✔️</button>
                                        </form>
                                    }

                                    <!-- ❌ Cancelar (estado 5), solo si está en estado 1 (Solicitado) -->
                                    @if (plato.IdEstadopedido == 1)
                                    {
                                        <form asp-action="CambiarEstadoDetallePedido" method="post" class="d-inline">
                                            <input type="hidden" name="idDetallePedido" value="@plato.IdPedido" />
                                            <input type="hidden" name="idMenu" value="@plato.IdMenu" />
                                            <input type="hidden" name="IdEstadoDetallePedido" value="5" />
                                            <button type="submit" class="btn btn-outline-danger btn-sm me-1" title="Cancelar Pedido">❌</button>
                                        </form>
                                    }


                                    @* ✏️ Botón editar y 🗑️ eliminar se mantienen *@
                                    <a asp-action="EditarDetalle" asp-route-id="@plato.IdPedido" class="btn btn-outline-primary btn-sm me-1">✏️</a>
                                    <a asp-action="EliminarDetalle" asp-route-id="@plato.IdPedido" class="btn btn-outline-danger btn-sm">🗑️</a>
                                </div>

                            </div>
                        </div>
                    </div>
                }

            }


            <!-- Botones para añadir diferentes tipos de items -->
            <div class="d-flex flex-wrap gap-2 mt-3">
                <a asp-action="VisualizarMenuOnlyPlatos" asp-controller="Mesero" asp-route-idMesa="@mesa" class="btn btn-outline-primary">
                    <i class="fas fa-utensils"></i> Añadir Plato
                </a>

                <a asp-action="VisualizarMenuOnlyCombos" asp-controller="Mesero" asp-route-idMesa="@mesa" class="btn btn-outline-secondary">
                    <i class="fas fa-box"></i> Añadir Combo
                </a>

                <a asp-action="VisualizarMenuOnlyPromociones" asp-controller="Mesero" asp-route-idMesa="@mesa" class="btn btn-outline-info">
                    <i class="fas fa-tag"></i> Añadir Promoción
                </a>
            </div>
        </div>

        <!-- Resumen del pedido -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3 text-secondary">📋 Resumen del Pedido</h5>
                    <p><strong>Subtotal:</strong> $@total.ToString("0.00")</p>
                    <p><strong>Descuento:</strong> $0.00</p>
                    <hr />
                    <p class="fw-bold fs-5">Total: $@total.ToString("0.00")</p>

                <!-- Botones de acción -->
                <form asp-action="EnviarCocina" method="post" class="mb-2">
                    <input type="hidden" name="idMesa" value="@mesa" />
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-rocket"></i> Enviar a Cocina
                    </button>
                </form>

                <form asp-action="FinalizarOrden" method="post">
                    <input type="hidden" name="idMesa" value="@mesa" />
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-check"></i> Finalizar Orden
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>